!function(){"use strict";angular.module("whoamiFrontend",["ngAnimate","ngTouch","ngMessages","ngAria","ui.router","angular-jsonapi","angular-jsonapi-local","angular-jsonapi-rest","ngCable"])}(),function(){"use strict";function t(t,e,n,s){function a(){function s(s){console.log("resolved",s),localStorage.setItem("userId",t.user.data.id),n(function(){e.go("in.menu")},1500)}function a(t){console.log("rejected",t)}t.user.save().then(s,a),console.log(t.user),t.welcomeMessageShow=!0}t.user=s.initialize(),t.letsGo=a,t.welcomeMessageShow=!1}t.$inject=["$scope","$state","$timeout","Users"],angular.module("whoamiFrontend").controller("StartController",t)}(),function(){"use strict";function t(t){return t.getResource("users")}t.$inject=["$jsonapi"],angular.module("whoamiFrontend").run(["$jsonapi","apiURL",function(t,e){var n={type:"users",id:"uuid4",attributes:{name:{presence:!0}},relationships:{messages:{type:"hasMany",reflection:"author"},conversations:{type:"hasMany",reflection:!1}},functions:{toString:function(){return this.data.attributes.name?this.data.attributes.name:this.data.id}}},s=t.sourceLocal.create("LocalStore synchronization","AngularJsonAPI"),a=t.sourceRest.create("Rest synchronization",e+"/users"),o=t.synchronizerSimple.create([s,a]);t.addResource(n,o)}]).factory("Users",t)}(),function(){"use strict";function t(t){return t.getResource("messages")}t.$inject=["$jsonapi"],angular.module("whoamiFrontend").run(["$jsonapi","apiURL",function(t,e){var n={type:"messages",id:"uuid4",attributes:{text:{presence:!0}},relationships:{conversation:{type:"hasOne"},author:{type:"hasOne",model:"users",include:!0}},functions:{toString:function(){return this.data.attributes.name?this.data.attributes.name:this.data.id}}},s=t.sourceRest.create("Rest synchronization",e+"/messages"),a=t.synchronizerSimple.create([s]);t.addResource(n,a)}]).factory("Messages",t)}(),function(){"use strict";function t(t,e,n){var s=t.getResource("conversations");return s.channel=e.subscriptions.create({channel:"ConversationsChannel"},["created","joined"]),console.log(s.channel),s.channel.on("connected",function(){console.log("Connected to Conversations!")}),s.channel.on("update",function(t){console.log("updated conversation",t)}),s}t.$inject=["$jsonapi","$cable","$rootScope"],angular.module("whoamiFrontend").run(["$jsonapi","apiURL",function(t,e){var n={type:"conversations",id:"uuid4",attributes:{status:{},respondent:{},answer:{},length:{}},relationships:{messages:{included:!0,type:"hasMany"},author:{included:!0,type:"hasOne",model:"users"},whoami:{included:!0,type:"hasOne",model:"users"}},include:{get:["messages.author"]},functions:{toString:function(){return this.data.attributes.name?this.data.attributes.name:this.data.id}}},s=t.sourceRest.create("Rest synchronization",e+"/conversations"),a=t.synchronizerSimple.create([s]);t.addResource(n,a)}]).factory("Conversations",t)}(),function(){"use strict";function t(t,e,n,s,a,o,i){function r(){if(0===t.open.length)return void console.log("No free conversations");var n=t.open[Math.floor(Math.random()*t.open.length)];a.channel.send({action:"joined",conversation:n.data.id,user:o.data.id}),e.go("in.conversation",{id:n.data.id})}function c(){console.log("start");var n=a.initialize();n.form.link("author",o),n.form.data.attributes.length=t.length,n.save().then(function(){e.go("in.conversation",{id:n.data.id})},function(t){console.log(t)})}t.conversations=i,t.user=o,t.join=r,t.start=c,t.length=1,a.channel.on("created",function(){t.conversations=a.all()}),t.$watchCollection("conversations.data",function(e){void 0!==e&&(t.open=e.filter(function(t){return"open"===t.data.attributes.status&&t.relationships.author!==o}))})}t.$inject=["$scope","$state","$cable","cableURL","Conversations","user","conversations"],angular.module("whoamiFrontend").controller("MainController",t)}(),function(){"use strict";function t(t,e,n,s,a,o,i,r,c){function l(t){i.form.data.attributes.answer=t,i.save().then(function(){console.log("YOUR ANSWER WAS ",t)})}function u(){return void 0===i.relationships.messages||"open"===i.data.attributes.status||"finished"===i.data.attributes.status||r===i.relationships.whoami&&i.relationships.messages.length%2===0||r===i.relationships.whoami&&"bot"===i.data.attributes.respondent||r===i.relationships.author&&i.relationships.messages.length%2===1}function d(){return r===i.relationships.author&&"finished"===i.data.attributes.status&&null===i.data.attributes.answer}function h(){return r!==i.relationships.author&&"finished"===i.data.attributes.status&&null===i.data.attributes.answer}function g(t,e){var n=a.defer();return e=void 0===e?1:e,e>2?n.reject():c.ask(t,function(a,o){a===!0?(console.log("Error nb",e,o),s(function(){g(t,e+1).then(function(t){n.resolve(t)},n.reject)},500)):s(function(){n.resolve(o)},500)}),n.promise}function v(e){var n=o.initialize();console.log(i),n.form.data.attributes.text=e,n.link("author",r),n.form.link("author",r),n.link("conversation",i),n.form.link("conversation",i),n.save().then(function(){},function(t){console.log(t)}),t.text=""}t.conversation=i,t.user=r,t.text="",t.post=v,t.conversation.refresh();var m=n.subscriptions.create({channel:"ConversationChannel",id:i.data.id},["updated","newMessage"]);console.log(t.conversation),m.on("connected",function(){console.log("Connected to Conversation "+i.data.id)}),m.on("updated",function(e){console.log("Updated ",e),s(function(){t.conversation.refresh().then(function(){console.log(t.conversation.data.attributes.respondent)})},20)}),m.on("newMessage",function(e){console.log("New message ",e),s(function(){t.conversation.refresh()},20)}),t.disabled=u,t.showSurvey=d,t.showDisabledSurvey=h,t.answer=l,t.$watch("conversation.relationships.messages.length",function(t){if(r===i.relationships.whoami&&"bot"===i.data.attributes.respondent&&t%2===1){console.log("Clever response");var e=i.relationships.messages[i.relationships.messages.length-1],n=e.data.attributes.text;console.log(n),g(n).then(v)}})}t.$inject=["$scope","$state","$cable","$timeout","$q","Messages","conversation","user","cleverbot"],angular.module("whoamiFrontend").controller("ConversationController",t)}(),function(){"use strict";function t(t){t.channel.send({action:"index"})}t.$inject=["Conversations"],angular.module("whoamiFrontend").controller("CableController",t)}(),function(){"use strict";function t(t){t.debug("runBlock end")}t.$inject=["$log"],angular.module("whoamiFrontend").run(t)}(),function(){"use strict";function t(t,e,n){t.state("cable",{url:"/cable",templateUrl:"app/cable/cable.html",controller:"CableController"}).state("start",{url:"/start",templateUrl:"app/start/start.html",controller:"StartController",resolve:{user:["$state","$q","$timeout",function(t,e,n){var s=localStorage.getItem("userId");return null!==s?(n(function(){t.go("in.menu")}),e.reject()):void 0}]}}).state("in",{url:"","abstract":!0,template:"<ui-view></ui-view>",resolve:{user:["$state","$q","$timeout","Users",function(t,e,n,s){function a(){n(function(){t.go("start")}),i.reject()}var o=localStorage.getItem("userId"),i=e.defer();null===o&&a();var r=s.get(o);return r.promise.then(function(){i.resolve(r)},function(){localStorage.removeItem("userId"),a()}),i.promise}]}}).state("in.menu",{url:"/",templateUrl:"app/main/main.html",controller:"MainController",resolve:{conversations:["Conversations",function(t){return t.all()}]}}).state("in.conversation",{url:"/{id:"+n+"}",templateUrl:"app/conversation/conversation.html",controller:"ConversationController",resolve:{conversation:["Conversations","$stateParams",function(t,e){return t.get(e.id)}]}}),e.otherwise("/")}t.$inject=["$stateProvider","$urlRouterProvider","uuid4Regex"],angular.module("whoamiFrontend").config(t)}(),function(){"use strict";var t="[a-f0-9]{8}-?[a-f0-9]{4}-?4[a-f0-9]{3}-?[89ab][a-f0-9]{3}-?[a-f0-9]{12}",e=require("cleverbot");angular.module("whoamiFrontend").constant("uuid4Regex",t).constant("apiURL","//localhost:5002").constant("cableURL","ws://localhost:5002/cable").constant("Cable",window.ActionCableReact.Cable).constant("$cable",window.ActionCableReact.ActionCable.createConsumer("ws://localhost:5002/cable")).constant("cleverbot",new e("HlgZbIBb8jpa7HxE","PLhnwSBIeuGvDRPQWi0jlpHgwKwfVnwS"))}(),function(){"use strict";function t(t){t.debugEnabled(!0)}t.$inject=["$logProvider"],angular.module("whoamiFrontend").config(t)}(),angular.module("whoamiFrontend").run(["$templateCache",function(t){t.put("app/cable/cable.html","<h1>CABLE</h1>"),t.put("app/conversation/conversation.html",'<div class="container"><div class="header"><h1 class="header__heading">Conversation {{conversation.data.attributes.length}}</h1><h4>{{conversation.data.attributes.length * 2 - conversation.relationships.messages.length}} messages till the judgment</h4><a class="header__subheading" href="" ui-sref="in.menu">Back</a></div><div class="chat"></div><div class="wait-message" ng-hide="conversation.relationships.whoami"><h4 class="wait-message__text">Wait for someone to join.</h4></div><div class="bot-message" ng-show="conversation.data.attributes.respondent === \'bot\' && conversation.relationships.whoami === user"><h4 class="bot-message__text">Cleverbot will answer for you this time!</h4></div><div class="finished-message" ng-show="conversation.data.attributes.status === \'finished\'"><h2 class="finished-message__text">Chat finished</h2><div class="finished-message__survey" ng-show="showSurvey()"><h4 class="finished-message__text">Who were you talking with?</h4><button class="finished-message__survey__button" ng-click="answer(\'bot\')">Bot</button> <button class="finished-message__survey__button" ng-click="answer(\'human\')">Human</button></div><div class="finished-message__survey" ng-show="showDisabledSurvey()"><h4 class="finished-message__text">Now the user is guessing who were he talking to.</h4></div><div class="finished-message__answer" ng-show="conversation.data.attributes.answer"><span ng-show="conversation.data.attributes.answer === conversation.data.attributes.respondent">Right, it was a {{conversation.data.attributes.respondent}}</span> <span ng-hide="conversation.data.attributes.answer === conversation.data.attributes.respondent">Wrong, it was a {{conversation.data.attributes.respondent}}</span><br><br><button class="button" ui-sref="in.menu"><i class="fa fa-arrow-left"></i> Back</button></div></div><div class="chat__messages"><div class="chat__messages__message" ng-class="{right: message.relationships.author === user}" ng-repeat="message in conversation.relationships.messages"><div class="chat__messages__message__text">{{message.data.attributes.text}}</div></div></div><div class="chat__input" ng-class="{disabled: disabled()}"><input class="chat__input__input" type="text" ng-model="text" ng-disabled="disabled()"> <button class="button chat__input__button" ng-click="post(text)" ng-disabled="disabled()">Send <i class="fa fa-arrow-right"></i></button></div></div>'),t.put("app/main/main.html",'<div class="container"><div class="content"><div class="icon-buttons"><div class="icon-buttons__button" ng-click="join()" ng-class="{\'icon-buttons__button--disabled\': !open.length}"><i class="fa fa-arrow-right icon-buttons__icon"></i><h2 class="icon-buttons__text">Join conversation</h2></div><div class="icon-buttons__button" ng-click="start()"><i class="fa fa-arrow-right icon-buttons__icon"></i><h2 class="icon-buttons__text">Start new conversation</h2></div></div></div></div>'),t.put("app/start/start.html",'<div class="container" ng-hide="welcomeMessageShow"><div class="content"><span class="input input__name input--hoshi"><input class="input__field input__field--hoshi" type="text" id="input-4" ng-model="user.form.data.attributes.name"> <label class="input__label input__label--hoshi input__label--hoshi-color-1" for="input-4" ng-hide="user.data.attributes.name"><span class="input__label-content input__label-content--hoshi">Your Name</span></label> <i class="fa fa-arrow-right input__icon--hoshi" ng-click="letsGo()"></i></span></div></div><div class="container" ng-show="welcomeMessageShow"><div class="content"><div class="profile"><h1 class="profile__name">Hi {{user.data.attributes.name}}</h1><img class="profile__image" ng-src="http://robohash.org/{{user.data.attributes.name}}" alt=""></div></div></div>')}]);
//# sourceMappingURL=../maps/scripts/app-4cc708e5c4.js.map
